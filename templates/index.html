{% load static %}
{% csrf_token %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>This is the new Shit!</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf_viewer.css"
          integrity="sha256-38OjONVckOd3ychWfXSACtQDuLbK9245iFtR/3wdo1c=" crossorigin="anonymous"/>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            height: 600px;
            width: 500px;
        }
    </style>
</head>
<body class="container-fluid">
<div class="row">
    <div class="col-6">
        <pre id="editor">
        </pre>
    </div>
    {% if data %}
        <div id="viewerContainer" class="col-6">
            <div id="viewer" class="pdfViewer"></div>
        </div>
    {% else %}
        <p class="col-6">No pdf availible.</p>
    {% endif %}
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.min.js"
        integrity="sha256-ZhtljvHDwAK9b75JdPQBOkaf1yBiJhSIEIBx7y/Hxes=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf_viewer.js"
        integrity="sha256-XHJo7f0KEZIjUEhP7AxCT4SdGhqvOS0NTSm7L2J5xeo=" crossorigin="anonymous"></script>
<script>
    /* Copyright 2014 Mozilla Foundation
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *     http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */

    'use strict';

    if (!pdfjsLib.getDocument || !pdfjsViewer.PDFViewer) {
        alert('Please build the pdfjs-dist library using\n' +
            '  `gulp dist-install`');
    }

    // The workerSrc property shall be specified.
    //
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.min.js';

    // Some PDFs need external cmaps.
    //
    var CMAP_URL = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf_viewer.js.map';
    var CMAP_PACKED = true;

    var DATA = '{{ data }}';
    DATA = DATA.replace(/b&#39;/g, '');
    DATA = DATA.replace(/&#39;/g, '');

    var container = document.getElementById('viewerContainer');

    // (Optionally) enable hyperlinks within PDF files.
    var pdfLinkService = new pdfjsViewer.PDFLinkService();

    var pdfViewer = new pdfjsViewer.PDFViewer({
        container: container,
        linkService: pdfLinkService,
        renderer: 'svg',
        textLayerMode: 0,
    });
    pdfLinkService.setViewer(pdfViewer);
    document.addEventListener('pagesinit', function () {
        // We can use pdfViewer now, e.g. let's change default scale.
        pdfViewer.currentScaleValue = 'page-width';
    });

    // Loading document.
    var loadingTask = pdfjsLib.getDocument({
        data: atob(DATA),
        cMapUrl: CMAP_URL,
        cMapPacked: CMAP_PACKED,
    });
    loadingTask.promise.then(function (pdfDocument) {
        // Document loaded, specifying document for the viewer and
        // the (optional) linkService.
        pdfViewer.setDocument(pdfDocument);

        pdfLinkService.setDocument(pdfDocument, null);
    });
</script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
<script src="{% static "node_modules/ace-builds/src-noconflict/ace.js" %}"></script>
<script src="{% static "node_modules/ace-builds/src-noconflict/ext-language_tools.js" %}"></script>
<script src="{% static "node_modules/ace-builds/src-noconflict/mode-latex.js" %}"></script>
<script src="{% static "node_modules/ace-builds/src-noconflict/snippets/latex.js" %}"></script>
<script>

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    ace.require("ace/ext/language_tools");
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/latex");
    editor.setTheme("ace/theme/monokai");
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: false,
    });
    editor.commands.addCommand({
        name: "compileLatex",
        bindKey: {win: "Ctrl-Enter", mac: "Command-Enter"},
        exec: function (editor) {
            $.ajax({
                type: "POST",
                url: window.location,
                data: editor.getValue(),
            });
        }
    })
</script>
</body>
</html>